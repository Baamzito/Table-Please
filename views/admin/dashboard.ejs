<%- include('../partials/header') %> <%- include('../partials/navbar') %>

<div class="container mt-5 pt-5" style="min-height: calc(100vh - 150px)">
  <% if (locals.success) { %>
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    <%= success %>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  <% } %> <% if (locals.error) { %>
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    <%= error %>
    <button
      type="button"
      class="btn-close"
      data-bs-dismiss="alert"
      aria-label="Close"
    ></button>
  </div>
  <% } %>

  <h2 class="mb-4">Administration Panel</h2>

  <!-- Stats Cards -->
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Validated Restaurant Owners</h5>
          <p class="display-4 mb-3"><%= validatedUsersCount || 0 %></p>
          <a
            href="/admin/validated-restaurant-owners"
            class="btn btn-sm btn-outline-primary"
            >View All</a
          >
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Pending Restaurant Owners</h5>
          <p class="display-4 mb-3"><%= pendingUsersCount || 0 %></p>
          <button class="btn btn-sm btn-outline-primary" disabled>
            View All
          </button>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h5 class="card-title">Total Restaurants</h5>
          <p class="display-4 mb-3"><%= totalRestaurantsCount || 0 %></p>
          <a href="/admin/restaurants" class="btn btn-sm btn-outline-primary"
            >View All</a
          >
        </div>
      </div>
    </div>
  </div>

  <!-- User Validation Section -->
  <div class="card shadow-sm mb-4">
    <div
      class="card-header bg-white d-flex justify-content-between align-items-center"
    >
      <h5 class="card-title mb-0">
        Users With Restaurant Role Pending Validation
      </h5>
    </div>
    <div class="card-body">
      <% if (pendingUsers && pendingUsers.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Profile</th>
              <th>Name</th>
              <th>Username</th>
              <th>Email</th>
              <th>Registration Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% pendingUsers.forEach(user => { %>
            <tr>
              <td>
                <img
                  src="<%= user.profileImage || '/images/default-avatar.jpg' %>"
                  alt="Profile"
                  class="rounded-circle"
                  style="width: 40px; height: 40px; object-fit: cover"
                />
              </td>
              <td><%= user.firstName + ' ' + user.lastName %></td>
              <td>@<%= user.username %></td>
              <td><%= user.email %></td>
              <td>
                <%= new Date(user.createdAt).toLocaleDateString('en-US', { year:
                'numeric', month: 'short', day: 'numeric' }) %>
              </td>
              <td>
                <div class="btn-group">
                  <form
                    action="/admin/validate-user/<%= user._id %>"
                    method="POST"
                    class="d-inline"
                  >
                    <button
                      type="submit"
                      class="btn btn-sm btn-success"
                      onclick="return confirm('Are you sure you want to validate this restaurant user?')"
                    >
                      <i class="fas fa-check"></i> Validate
                    </button>
                  </form>
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary ms-1"
                    data-bs-toggle="modal"
                    data-bs-target="#userModal<%= user._id %>"
                  >
                    <i class="fas fa-eye"></i> Details
                  </button>
                </div>

                <!-- User Details Modal -->
                <div
                  class="modal fade"
                  id="userModal<%= user._id %>"
                  tabindex="-1"
                  aria-labelledby="userModalLabel<%= user._id %>"
                  aria-hidden="true"
                >
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h5
                          class="modal-title"
                          id="userModalLabel<%= user._id %>"
                        >
                          User Details
                        </h5>
                        <button
                          type="button"
                          class="btn-close"
                          data-bs-dismiss="modal"
                          aria-label="Close"
                        ></button>
                      </div>
                      <div class="modal-body">
                        <div class="text-center mb-3">
                          <img
                            src="<%= user.profileImage || '/images/default-avatar.jpg' %>"
                            alt="Profile Picture"
                            class="img-fluid rounded-circle profile-image mb-3"
                            style="
                              width: 100px;
                              height: 100px;
                              object-fit: cover;
                            "
                          />
                        </div>
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <p class="text-muted small mb-1">Name</p>
                            <p class="mb-0">
                              <%= user.firstName + ' ' + user.lastName %>
                            </p>
                          </div>
                          <div class="col-md-6 mb-3">
                            <p class="text-muted small mb-1">Username</p>
                            <p class="mb-0">@<%= user.username %></p>
                          </div>
                          <div class="col-md-6 mb-3">
                            <p class="text-muted small mb-1">Email</p>
                            <p class="mb-0"><%= user.email %></p>
                          </div>
                          <div class="col-md-6 mb-3">
                            <p class="text-muted small mb-1">
                              Registration Date
                            </p>
                            <p class="mb-0">
                              <%= new
                              Date(user.createdAt).toLocaleDateString('en-US', {
                              year: 'numeric', month: 'long', day: 'numeric' })
                              %>
                            </p>
                          </div>
                          <% if(user.address) { %>
                          <div class="col-12 mb-3">
                            <p class="text-muted small mb-1">Address</p>
                            <p class="mb-0">
                              <%= user.address.street || '' %><br />
                              <%= user.address.city || '' %> <%=
                              user.address.postalCode || '' %>
                            </p>
                          </div>
                          <% } %>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button
                          type="button"
                          class="btn btn-secondary"
                          data-bs-dismiss="modal"
                        >
                          Close
                        </button>
                        <form
                          action="/admin/validate-user/<%= user._id %>"
                          method="POST"
                          class="d-inline"
                        >
                          <button type="submit" class="btn btn-success">
                            Validate User
                          </button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% } else { %>
      <div class="text-center py-4">
        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
        <h6 class="text-muted">No restaurant owners pending validation</h6>
      </div>
      <% } %>
    </div>
  </div>

  <!-- Restaurant Management Section -->
  <div class="card shadow-sm">
    <div
      class="card-header bg-white d-flex justify-content-between align-items-center"
    >
      <h5 class="card-title mb-0">Restaurant Management</h5>
      <button
        class="btn btn-sm btn-primary"
        data-bs-toggle="modal"
        data-bs-target="#addRestaurantModal"
      >
        <i class="fas fa-plus me-1"></i> Add Restaurant
      </button>
    </div>
    <div class="card-body">
      <!-- Table view for restaurants -->
      <% if (restaurantsList && restaurantsList.length > 0) { %>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead>
            <tr>
              <th>Restaurant Name</th>
              <th>Owner</th>
              <th>Location</th>
              <th>Contact</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% restaurantsList.forEach(restaurant => { %>
            <tr>
              <td>
                <div>
                  <p class="mb-0 fw-medium"><%= restaurant.name %></p>
                </div>
              </td>
              <td>
                <% if(restaurant.owner) { %>
                <div class="d-flex align-items-center">
                  <img
                    src="<%= restaurant.owner.profileImage || '/images/default-avatar.jpg' %>"
                    alt="Owner"
                    class="rounded-circle me-2"
                    style="width: 30px; height: 30px; object-fit: cover"
                  />
                  <%= restaurant.owner.firstName + ' ' +
                  restaurant.owner.lastName %>
                </div>
                <% } else { %>
                <span class="text-muted">No owner assigned</span>
                <% } %>
              </td>
              <td>
                <% if(restaurant.address && restaurant.address.city) { %>
                <i class="fas fa-map-marker-alt me-1"></i> <%=
                restaurant.address.city %> <% } else { %>
                <span class="text-muted">No location</span>
                <% } %>
              </td>
              <td>
                <% if(restaurant.contact && restaurant.contact.phone) { %>
                <i class="fas fa-phone me-1"></i> <%= restaurant.contact.phone
                %> <% } else { %>
                <span class="text-muted">No contact</span>
                <% } %>
              </td>
              <td>
                <div class="btn-group">
                  <button
                    class="btn btn-sm btn-outline-primary"
                    data-bs-toggle="modal"
                    data-bs-target="#editRestaurantModal<%= restaurant._id %>"
                  >
                    <i class="fas fa-edit"></i> Edit
                  </button>
                  <form
                    action="/admin/delete-restaurant/<%= restaurant._id %>"
                    method="POST"
                    class="ms-1"
                    onsubmit="return confirm('Are you sure you want to remove this restaurant?')"
                  >
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      <i class="fas fa-trash"></i> Remove
                    </button>
                  </form>
                </div>
              </td>
            </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% } else { %>
      <div class="text-center py-5">
        <i class="fas fa-utensils fa-3x text-secondary mb-3"></i>
        <h6 class="text-muted">No restaurants found</h6>
      </div>
      <% } %>
    </div>
  </div>
</div>

<!-- Add Restaurant Modal -->
<div
  class="modal fade"
  id="addRestaurantModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/admin/add-restaurant" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Add New Restaurant</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- Restaurant add form fields -->
          <div class="mb-3">
            <label for="name" class="form-label">Restaurant Name*</label>
            <input
              type="text"
              class="form-control"
              id="name"
              name="name"
              required
            />
          </div>
          <div class="mb-3">
            <label for="owner" class="form-label">Owner</label>
            <select class="form-select" id="owner" name="owner">
              <option value="">Select an owner</option>
              <% if (restaurantOwners && restaurantOwners.length > 0) { %> <%
              restaurantOwners.forEach(owner => { %>
              <option value="<%= owner._id %>">
                <%= owner.firstName %> <%= owner.lastName %> (@<%=
                owner.username %>)
              </option>
              <% }) %> <% } %>
            </select>
          </div>

          <h6 class="mt-4 mb-3">Address Information</h6>
          <div class="mb-3">
            <label for="address_street" class="form-label"
              >Street Address*</label
            >
            <input
              type="text"
              class="form-control"
              id="address_street"
              name="address_street"
              required
            />
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="address_city" class="form-label">City*</label>
              <input
                type="text"
                class="form-control"
                id="address_city"
                name="address_city"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="address_postcode" class="form-label">Postcode*</label>
              <input
                type="text"
                class="form-control"
                id="address_postcode"
                name="address_postcode"
                required
              />
            </div>
          </div>

          <h6 class="mt-4 mb-3">Contact Information</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="contact_phone" class="form-label"
                >Phone Number*</label
              >
              <input
                type="tel"
                class="form-control"
                id="contact_phone"
                name="contact_phone"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="contact_email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                id="contact_email"
                name="contact_email"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Add Restaurant</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Restaurant Modals -->
<% if (restaurantsList && restaurantsList.length > 0) { %> <%
restaurantsList.forEach(restaurant => { %>
<div
  class="modal fade"
  id="editRestaurantModal<%= restaurant._id %>"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <form action="/admin/edit-restaurant/<%= restaurant._id %>" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Edit Restaurant</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <!-- Restaurant edit form fields -->
          <div class="mb-3">
            <label for="name<%= restaurant._id %>" class="form-label"
              >Restaurant Name*</label
            >
            <input
              type="text"
              class="form-control"
              id="name<%= restaurant._id %>"
              name="name"
              value="<%= restaurant.name %>"
              required
            />
          </div>

          <h6 class="mt-4 mb-3">Address Information</h6>
          <div class="mb-3">
            <label for="address<%= restaurant._id %>" class="form-label"
              >Street Address*</label
            >
            <input
              type="text"
              class="form-control"
              id="address<%= restaurant._id %>"
              name="address[street]"
              value="<%= restaurant.address ? restaurant.address.street : '' %>"
              required
            />
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="city<%= restaurant._id %>" class="form-label"
                >City*</label
              >
              <input
                type="text"
                class="form-control"
                id="city<%= restaurant._id %>"
                name="address[city]"
                value="<%= restaurant.address ? restaurant.address.city : '' %>"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="postcode<%= restaurant._id %>" class="form-label"
                >Postcode*</label
              >
              <input
                type="text"
                class="form-control"
                id="postcode<%= restaurant._id %>"
                name="address[postcode]"
                value="<%= restaurant.address ? restaurant.address.postcode : '' %>"
                required
              />
            </div>
          </div>

          <h6 class="mt-4 mb-3">Contact Information</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="phone<%= restaurant._id %>" class="form-label"
                >Phone Number*</label
              >
              <input
                type="tel"
                class="form-control"
                id="phone<%= restaurant._id %>"
                name="contact[phone]"
                value="<%= restaurant.contact ? restaurant.contact.phone : '' %>"
                required
              />
            </div>
            <div class="col-md-6 mb-3">
              <label for="email<%= restaurant._id %>" class="form-label"
                >Email</label
              >
              <input
                type="email"
                class="form-control"
                id="email<%= restaurant._id %>"
                name="contact[email]"
                value="<%= restaurant.contact ? restaurant.contact.email : '' %>"
              />
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>
</div>
<% }) %> <% } %> <%- include('../partials/footer') %>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>